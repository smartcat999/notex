name: swe-agent-bot

on:
  issues:
    types: [labeled]

jobs:
  run:
    if: contains(github.event.issue.labels.*.name, 'bot:fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      # 统一分支命名，避免并发冲突
      SWE_BRANCH: swe-agent/issue-${{ github.event.issue.number }}-${{ github.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          fetch-depth: 0
          token: ${{ secrets.SWE_AGENT_GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      - name: Install SWE-agent
        run: |
          python -m pip install --upgrade pip
          # 需要克隆完整仓库以包含 config 目录
          git clone --depth 1 https://github.com/SWE-agent/SWE-agent.git /tmp/swe-agent
          cd /tmp/swe-agent
          pip install -e .
          # 确保 config 目录存在
          ls -la config/ || echo "Warning: config directory not found"

      - name: Configure git identity for PR commits
        run: |
          git config user.name "swe-agent-bot"
          git config user.email "swe-agent-bot@users.noreply.github.com"

      # 使用 GitHub 模式，让 SWE-agent 直接在远端仓库操作并自动创建 PR
      - name: Run SWE-agent (GitHub mode with auto PR)
        env:
          GITHUB_TOKEN: ${{ secrets.SWE_AGENT_GH_TOKEN }}
          # 二选一：如果你走 Anthropic 原生 API，则用这个
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # 二选一：如果你走 OpenAI 兼容代理(例如 LiteLLM/OpenRouter/自建网关)，可用 OPENAI_API_KEY
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd /tmp/swe-agent
          sweagent run \
            --config config/default.yaml \
            --config ${{ github.workspace }}/.github/swe-agent.yaml \
            --env.repo.type=github \
            --agent.model.per_instance_cost_limit=2.00 \
            --env.repo.github_url=https://github.com/${{ github.repository }} \
            --problem_statement.github_url=https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}

      # SWE-agent 会自动创建 PR，所以这里不需要手动创建
      # 如果 SWE-agent 创建 PR 失败，可以在这里添加 fallback 逻辑
      - name: Comment on issue (if PR created by SWE-agent)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.SWE_AGENT_GH_TOKEN }}
        run: |
          echo "SWE-agent should have created PR automatically. Check the logs above for PR link."
          # 可选：通过 API 检查是否创建了 PR
          gh pr list --head swe-agent --json number,title,url --jq '.[0] | "✅ PR created: #\(.number) - \(.title) - \(.url)"' || echo "No PR found yet"
