name: swe-agent-bot

on:
  issues:
    types: [labeled]

jobs:
  run:
    if: contains(github.event.issue.labels.*.name, 'bot:fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      # ç»Ÿä¸€åˆ†æ”¯å‘½åï¼Œé¿å…å¹¶å‘å†²çª
      SWE_BRANCH: swe-agent/issue-${{ github.event.issue.number }}-${{ github.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          fetch-depth: 0
          token: ${{ secrets.SWE_AGENT_GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      - name: Install SWE-agent
        run: |
          python -m pip install --upgrade pip
          # ä¹Ÿå¯ä»¥å›ºå®š commitï¼Œé¿å…ä¸Šæ¸¸å˜åŠ¨å½±å“
          pip install "git+https://github.com/SWE-agent/SWE-agent.git"

      - name: Configure git identity for PR commits
        run: |
          git config user.name "swe-agent-bot"
          git config user.email "swe-agent-bot@users.noreply.github.com"

      # å…³é”®ï¼šè®© SWE-agent ä¿®æ”¹â€œå½“å‰å·¥ä½œåŒºâ€çš„ä»£ç 
      - name: Run SWE-agent (edit local workspace)
        env:
          GITHUB_TOKEN: ${{ secrets.SWE_AGENT_GH_TOKEN }}
          # äºŒé€‰ä¸€ï¼šå¦‚æžœä½ èµ° Anthropic åŽŸç”Ÿ APIï¼Œåˆ™ç”¨è¿™ä¸ª
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # äºŒé€‰ä¸€ï¼šå¦‚æžœä½ èµ° OpenAI å…¼å®¹ä»£ç†(ä¾‹å¦‚ LiteLLM/OpenRouter/è‡ªå»ºç½‘å…³)ï¼Œå¯ç”¨ OPENAI_API_KEY
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          sweagent run \
            --config ${{ github.workspace }}/.github/swe-agent.yaml \
            --env.repo.type=local \
            --env.repo.path=${{ github.workspace }} \
            --problem_statement.github_url=https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}

      - name: Create pull request if changes exist
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.SWE_AGENT_GH_TOKEN }}
          branch: ${{ env.SWE_BRANCH }}
          base: ${{ github.event.repository.default_branch }}
          commit-message: "[SWE-Agent] Auto fix for #${{ github.event.issue.number }}"
          title: "[SWE-Agent] Auto fix for #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          body: |
            This PR was automatically generated by SWE-Agent ðŸ¤–

            **Issue:** #${{ github.event.issue.number }}
            **Actor:** ${{ github.actor }}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            > If something looks off, close this PR and remove the `bot:fix` label.
          labels: automated, ai-fix
          assignees: ${{ github.actor }}
          draft: false

      - name: Comment on issue with PR link
        if: steps.cpr.outputs.pull-request-number != ''
        uses: actions-ecosystem/action-add-comment@v2
        with:
          github_token: ${{ secrets.SWE_AGENT_GH_TOKEN }}
          issue_number: ${{ github.event.issue.number }}
          comment: |
            âœ… Created PR #${{ steps.cpr.outputs.pull-request-number }} from branch `${{ env.SWE_BRANCH }}`.
            Thanks for the label `bot:fix` â€” review the changes when you have a moment.
